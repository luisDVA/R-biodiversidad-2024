---
title: "Distribuciones geográficas"
author: Juliana Herrera-Pérez & Fabricio Villalobos
format: revealjs
editor: visual
---

## Área de distribución geográfica

> "...el espacio donde las condiciones ecológicas favorecen, real o potencialmente y en varios niveles, las interacciones no efímeras de los individuos de una especie" Mota-Vargas & Rojas-Soto 2012

## Puntos, polígonos y mapas de distribución

Los registros (colectas georeferenciadas) de las especies son los datos primarios de biodiversidad, a partir de los cuáles podemos estimar las áreas de distribución de estas y describir/evaluar los patrones de diversidad que emergen de su agregación (traslape; e.g., gradiente geográfico de riqueza)

. . .

## 

-   En este ejemplo/ejercicio veremos cómo obtener dichos registros directamente desde R

. . .

-   También, veremos cómo generar áreas de distribución (extenciones de presencia) a partir de estos registros, creando polígonos de diferentes tipos (mínimo, alpha y alpha dinámico)

. . .

-   Los datos de registros serán obtenidos de la plataforma en línea [Global Biodiversity Information Facility - GBIF](https://www.gbif.org/)

. . .

## Paquetes necesarios:

```{r}
#| eval: true
#| echo: true
library(rgbif)
library(dplyr)
library(ggplot2)
library(sf)
library(rnaturalearth)
library(alphahull)
library(rangeBuilder)
library(janitor)
```

# Obteniendo registros de presencia de GBIF

## 

Para comenzar podemos escoger una especie y aplicar la función `occ_data`

El objeto `sp_data` es una lista con datos sobre los resultados obtenidos en GBIF (incluyendo algunos metadatos)

Para trabajar únicamente con la tabla de registros hay que seleccionar el objeto data dentro del mismo

```{r}
#| eval: true
#| echo: true
sp_data <- occ_data(scientificName = "Musonycteris harrisoni", limit = 500)[[2]]

```

. . .

## 

Checar el nombre de las columnas (para después buscar únicamente las de posición geográfica: lat/long)

```{r}
#| eval: true
#| echo: true
names(sp_data)[1:30]
```

. . .

## 

1.Crear otro objeto a partir `sp_data` únicamente con long/lat

. . .

2.Quedarse únicamente con los puntos/registros individuales (i.e., excluir duplicados)

. . .

3.Transformarlo en un objeto espacial

. . .

```{r}
#| eval: true
#| echo: true
sp_p1<-sp_data%>%
  select(decimalLongitude,decimalLatitude,species)%>%
  mutate(lat=decimalLatitude,lon=decimalLongitude)%>%
  distinct() %>%
  na.omit() %>% 
  sf::st_as_sf(coords = c('decimalLongitude','decimalLatitude'),crs="EPSG: 4326")

```

::: {.alert .alert-success role="alert"}
NOTA: el nombre de la variable puede ser diferente (.e.g "LATITUDE", "Latidude", "lat", etc. Siempre hay que checar antes)
:::

. . .

## 

Graficar (poner en un mapa) los puntos de presencia de nuestra especie

```{r}
#| eval: true
#| echo: true
ggplot()+ geom_sf(data=sp_p1, col="blue",pch=19)
```

## 

Agregar el mapa del mundo para saber qué onda!

```{r}
#| eval: true
#| echo: true
wrld <- ne_countries(scale = "small",returnclass = "sf")
```

```{r}
#| eval: true
#| echo: true
ggplot()+
  geom_sf(data=wrld)+geom_sf(data=sp_p1,col="blue",pch=19,size=1)+coord_sf(expand = F) +
  labs(x="Longitud decimal ",
       y="Latitud decimal",
       title=expression(paste("Puntos reportados ", italic("Musonycteris harrisoni"))))+
  theme(plot.title = element_text(hjust = 0.5))
```

## 

Hay algo claramente equivocado, ¿cierto? Los puntos/registros necesitan ser "curados" (limpiados)

. . .

Eliminar los puntos con mala georeferencia (en este caso, puntos obvios en el "viejo mundo")

```{r}
#| eval: true
#| echo: true
sp_p1<-sp_data%>%
  select(decimalLongitude,decimalLatitude,species)%>%
  mutate(lat=decimalLatitude,lon=decimalLongitude)%>%
  distinct() %>% na.omit() %>% 
  sf::st_as_sf(coords = c('decimalLongitude','decimalLatitude'),crs="EPSG: 4326")%>%
  filter(lat> 0.5) %>% filter(lat< 22)

```

## 

Ahora sí, mapeamos de nuevo pero sólamente en la región de interés (México)

```{r}
#| eval: true
#| echo: true
mex_map <- filter(wrld,name=="Mexico")
```

. . .

```{r}
#| eval: true
#| echo: true
ggplot()+geom_sf(data=mex_map)+
  geom_sf(data=sp_p1,col="blue",pch=19,size=1)+coord_sf(expand = F)
```

. . .

## 

Y ¿Cómo eliminamos los registros que están en el mar?

```{r}
#| eval: true
#| echo: true
sp_p1<-sp_data%>%
  select(decimalLongitude,decimalLatitude,species)%>%
  mutate(lat=decimalLatitude,lon=decimalLongitude)%>%
  distinct() %>%
  na.omit() %>% 
  sf::st_as_sf(coords = c('decimalLongitude','decimalLatitude'),crs="EPSG: 4326")%>%
  filter(lat> 0.5) %>%
  filter(lat< 22)%>%
  filter(lon> -105.56611)
```

# Polígono convexo mínimo

## 

Una vez tenemos los datos curados, podemos crear nuestro mcp


. . .

¿Cómo se ve?

